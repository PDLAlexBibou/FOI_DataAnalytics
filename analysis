#!/usr/bin/env python3

import pandas as pd
import numpy as np
import re
import argparse
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
from matplotlib.colors import LinearSegmentedColormap
from faker import Faker
import os


def compute_letter_grade(score_0_100: float) -> str:
    """Convert numeric grade (0-100) into a letter grade."""
    if score_0_100 >= 90:
        return "A"
    elif score_0_100 >= 75:
        return "B"
    elif score_0_100 >= 61:
        return "C"
    elif score_0_100 >= 50:
        return "D"
    return "F"


def build_dataframe(input_csv: str) -> pd.DataFrame:
    df = pd.read_csv(input_csv)
    df = fake_student_names(df, seed=42, locale="en_US")

    quiz_cols = [c for c in df.columns if re.fullmatch(r"KVIZ\d+", c)]
    midterm_cols = [c for c in df.columns if re.fullmatch(r"MIDTERM\d+", c)]
    project_col = "PROJECT"

    assessment_cols = quiz_cols + midterm_cols + [project_col]

    for col in assessment_cols:
        df[col] = (
            df[col]
            .replace("-", np.nan)
            .astype(str)
            .str.replace(",", ".", regex=False)
        )
        df[col] = pd.to_numeric(df[col], errors="coerce")

    df["MissingCount"] = df[assessment_cols].isna().sum(axis=1)
    df[assessment_cols] = df[assessment_cols].fillna(0)

    df["QuizTotal"] = df[quiz_cols].sum(axis=1)
    df["MidtermTotal"] = df[midterm_cols].sum(axis=1)
    df["ProjectPoints"] = df[project_col]

    df["TotalScore"] = df["QuizTotal"] + df["MidtermTotal"] + df["ProjectPoints"]

    df["3PointsEachMidterm"] = (df[midterm_cols] >= 3).all(axis=1)
    df["25PointsMidtermTotal"] = df["MidtermTotal"] >= 25
    df["MeetsMidtermCriteria"] = df["3PointsEachMidterm"] & df["25PointsMidtermTotal"]

    df["Final Grade"] = df["TotalScore"].apply(compute_letter_grade)

    df.loc[~df["MeetsMidtermCriteria"], "Final Grade"] = "F"

    df["Result"] = np.where(df["Final Grade"].isin(["A", "B", "C", "D"]), "PASS", "FAIL")

    df = df.sort_values(by="TotalScore", ascending=False)

    return df


def export_to_png(df: pd.DataFrame, output_png: str):
    """Export the grade report as a PNG image."""
    
    # Calculate summary statistics
    grade_counts = (
        df["Final Grade"]
        .value_counts()
        .reindex(["A", "B", "C", "D", "F"], fill_value=0)
        .astype(int)
    )
    
    pass_rate = (df["Result"] == "PASS").mean() * 100
    total_students = len(df)
    avg_score = df["TotalScore"].mean()
    median_score = df["TotalScore"].median()
    missing_entries = int((df["MissingCount"] > 0).sum())
    
    # Prepare display dataframe (select key columns)
    display_cols = ["First name", "Surname", "QuizTotal", "MidtermTotal", 
                    "ProjectPoints", "TotalScore", "Final Grade", "Result"]
    display_cols = [c for c in display_cols if c in df.columns]
    display_df = df[display_cols].head(25).copy()  # Show top 25 students
    
    # Round numeric columns
    for col in ["QuizTotal", "MidtermTotal", "ProjectPoints", "TotalScore"]:
        if col in display_df.columns:
            display_df[col] = display_df[col].round(2)
    
    # Create figure with subplots
    fig = plt.figure(figsize=(16, 14))
    fig.patch.set_facecolor('#f8f9fa')
    
    # Title
    fig.suptitle('Course Results Summary', fontsize=24, fontweight='bold', 
                 color='#1F4E79', y=0.98)
    
    # Create grid layout
    gs = fig.add_gridspec(3, 2, height_ratios=[0.8, 0.8, 2.5], 
                          hspace=0.3, wspace=0.3,
                          left=0.05, right=0.95, top=0.92, bottom=0.05)
    
    # --- Summary Stats Box (top left) ---
    ax_summary = fig.add_subplot(gs[0, 0])
    ax_summary.axis('off')
    
    summary_text = (
        f"ðŸ“Š Total Students: {total_students}\n"
        f"âœ… Pass Rate: {pass_rate:.1f}%\n"
        f"ðŸ“ˆ Average Score: {avg_score:.2f}\n"
        f"ðŸ“‰ Median Score: {median_score:.2f}\n"
        f"âš ï¸ Missing Entries: {missing_entries} students"
    )
    
    ax_summary.text(0.5, 0.5, summary_text, transform=ax_summary.transAxes,
                    fontsize=14, verticalalignment='center', horizontalalignment='center',
                    bbox=dict(boxstyle='round,pad=0.8', facecolor='#E8F4FD', 
                              edgecolor='#1F4E79', linewidth=2),
                    family='monospace', linespacing=1.8)
    ax_summary.set_title('Summary Statistics', fontsize=14, fontweight='bold', 
                         color='#1F4E79', pad=10)
    
    # --- Grade Distribution Chart (top right) ---
    ax_chart = fig.add_subplot(gs[0, 1])
    
    colors = ['#28a745', '#5cb85c', '#f0ad4e', '#d9534f', '#c9302c']
    bars = ax_chart.bar(grade_counts.index, grade_counts.values, color=colors, 
                        edgecolor='white', linewidth=2)
    
    # Add value labels on bars
    for bar, val in zip(bars, grade_counts.values):
        height = bar.get_height()
        ax_chart.annotate(f'{val}',
                          xy=(bar.get_x() + bar.get_width() / 2, height),
                          xytext=(0, 3), textcoords="offset points",
                          ha='center', va='bottom', fontsize=12, fontweight='bold')
    
    ax_chart.set_xlabel('Grade', fontsize=12, fontweight='bold')
    ax_chart.set_ylabel('Number of Students', fontsize=12, fontweight='bold')
    ax_chart.set_title('Grade Distribution', fontsize=14, fontweight='bold', 
                       color='#1F4E79', pad=10)
    ax_chart.set_facecolor('#f8f9fa')
    ax_chart.spines['top'].set_visible(False)
    ax_chart.spines['right'].set_visible(False)
    
    # --- Pass/Fail Pie Chart (middle left) ---
    ax_pie = fig.add_subplot(gs[1, 0])
    
    pass_count = (df["Result"] == "PASS").sum()
    fail_count = (df["Result"] == "FAIL").sum()
    
    wedges, texts, autotexts = ax_pie.pie(
        [pass_count, fail_count], 
        labels=['PASS', 'FAIL'],
        colors=['#28a745', '#dc3545'],
        autopct='%1.1f%%',
        startangle=90,
        explode=(0.02, 0.02),
        shadow=True,
        textprops={'fontsize': 12, 'fontweight': 'bold'}
    )
    ax_pie.set_title('Pass/Fail Distribution', fontsize=14, fontweight='bold', 
                     color='#1F4E79', pad=10)
    
    # --- Score Distribution Histogram (middle right) ---
    ax_hist = fig.add_subplot(gs[1, 1])
    
    n, bins, patches = ax_hist.hist(df["TotalScore"], bins=15, edgecolor='white', 
                                     linewidth=1.2, alpha=0.8)
    
    # Color bins based on grade thresholds
    for i, (patch, left_edge) in enumerate(zip(patches, bins[:-1])):
        if left_edge >= 90:
            patch.set_facecolor('#28a745')
        elif left_edge >= 75:
            patch.set_facecolor('#5cb85c')
        elif left_edge >= 61:
            patch.set_facecolor('#f0ad4e')
        elif left_edge >= 50:
            patch.set_facecolor('#d9534f')
        else:
            patch.set_facecolor('#c9302c')
    
    ax_hist.axvline(avg_score, color='blue', linestyle='--', linewidth=2, label=f'Mean: {avg_score:.1f}')
    ax_hist.axvline(median_score, color='orange', linestyle='--', linewidth=2, label=f'Median: {median_score:.1f}')
    ax_hist.legend(loc='upper right')
    ax_hist.set_xlabel('Total Score', fontsize=12, fontweight='bold')
    ax_hist.set_ylabel('Frequency', fontsize=12, fontweight='bold')
    ax_hist.set_title('Score Distribution', fontsize=14, fontweight='bold', 
                      color='#1F4E79', pad=10)
    ax_hist.set_facecolor('#f8f9fa')
    ax_hist.spines['top'].set_visible(False)
    ax_hist.spines['right'].set_visible(False)
    
    # --- Student Table (bottom, full width) ---
    ax_table = fig.add_subplot(gs[2, :])
    ax_table.axis('off')
    
    # Create table
    table_data = display_df.values.tolist()
    col_labels = display_df.columns.tolist()
    
    table = ax_table.table(
        cellText=table_data,
        colLabels=col_labels,
        loc='center',
        cellLoc='center'
    )
    
    table.auto_set_font_size(False)
    table.set_fontsize(9)
    table.scale(1.2, 1.5)
    
    # Style the table
    for i, key in enumerate(table.get_celld().keys()):
        cell = table.get_celld()[key]
        if key[0] == 0:  # Header row
            cell.set_facecolor('#1F4E79')
            cell.set_text_props(color='white', fontweight='bold')
        else:
            # Color rows based on Result
            row_idx = key[0] - 1
            if row_idx < len(display_df):
                result = display_df.iloc[row_idx]["Result"]
                if result == "PASS":
                    cell.set_facecolor('#E2F0D9')
                else:
                    cell.set_facecolor('#F8D7DA')
    
    title_text = f'Top {len(display_df)} Students (sorted by Total Score)'
    if len(df) > 25:
        title_text += f' â€” showing {len(display_df)} of {len(df)} total'
    ax_table.set_title(title_text, fontsize=14, fontweight='bold', 
                       color='#1F4E79', pad=20)
    
    # Save figure
    plt.savefig(output_png, dpi=150, bbox_inches='tight', facecolor=fig.get_facecolor())
    plt.close()
    
    print(f"âœ… Report saved as PNG: {output_png}")


def fake_student_names(df: pd.DataFrame, seed: int = 42, locale: str = "en_US") -> pd.DataFrame:
    """
    Replace 'First name' and 'Surname' with fake names.
    - Deterministic with the same seed
    - Keeps 2 first names if original had 2+ parts
    - Ensures uniqueness (no duplicate fake full names)
    """
    if "First name" not in df.columns or "Surname" not in df.columns:
        raise KeyError("Expected columns: 'First name' and 'Surname'")

    fake = Faker(locale)
    Faker.seed(seed)

    df = df.copy()
    used = set()

    for i, row in df.iterrows():
        original_first = str(row["First name"]) if pd.notna(row["First name"]) else ""
        first_parts = [p for p in original_first.split() if p.strip()]
        n_first = max(1, len(first_parts))

        while True:
            fake_first = " ".join(fake.first_name() for _ in range(n_first))
            fake_last = fake.last_name()
            full = (fake_first, fake_last)
            if full not in used:
                used.add(full)
                break

        df.at[i, "First name"] = fake_first
        df.at[i, "Surname"] = fake_last

    return df


def main():
    parser = argparse.ArgumentParser(description="Create a visual grade report as PNG.")
    parser.add_argument("--input", required=True, help="Input CSV file")
    parser.add_argument("--output", default="final_results.png", help="Output PNG filename")
    args = parser.parse_args()

    df = build_dataframe(args.input)
    export_to_png(df, args.output)


if __name__ == "__main__":
    main()